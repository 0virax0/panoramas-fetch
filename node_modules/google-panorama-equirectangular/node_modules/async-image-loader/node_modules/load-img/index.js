var Image = require('canvas').Image;
var request = require("request");
module.exports = loadImage;

function loadImage (src, opt, callback) {
  if (typeof opt === 'function') {
    callback = opt;
    opt = null;
  }

  //var el = document.createElement('img');
  var el = new Image();
  var locked;


  if (opt && opt.crossOrigin) {
    el.crossOrigin = opt.crossOrigin;
  }

  //el.src = src;

  request.get({url:src, encoding: null}, function(err, res, body){
    if(err)console.log(err);

    el.onerror = function(e) {
      if (locked) return;
      locked = true;

      if (callback) callback(new Error('Unable to load "' + src + '"'), el);
      console.log("error loading sub image: "+ e);
    };

    el.onload = function() {
      if (locked) return;
      locked = true;
      //console.log(src)
      if (callback) callback(undefined, el);
      el = undefined;   //free up memory
    };

    el.src = new Buffer(body, 'binary');

  });
  //return el;
}
